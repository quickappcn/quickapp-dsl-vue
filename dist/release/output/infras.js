!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";var e="0.0.7";let t=null;const n=["off","error","warn","info","log","debug","trace"];let o={};function r(e){const t=global.Env&&global.Env.logLevel||"log";return o[t]&&o[t][e]}var s={setNativeConsole:function(){t=global.console,n.forEach(e=>{const t=n.indexOf(e);o[e]={},n.forEach(r=>{n.indexOf(r)<=t&&(o[e][r]=!0)})});{const{trace:e,debug:t,log:n,info:o,warn:s,error:l,time:a,timeEnd:i}=console,c=console;console._ori={trace:e,debug:t,log:n,info:o,warn:s,error:l,time:a,timeEnd:i},c.trace=((...e)=>{r("trace")&&console._ori.debug.apply(console,e)}),c.debug=((...e)=>{r("debug")&&(console._ori.debug||console._ori.trace).apply(console,e)}),c.log=((...e)=>{r("log")&&console._ori.log.apply(console,e)}),c.info=((...e)=>{r("info")&&console._ori.info.apply(console,e)}),c.warn=((...e)=>{r("warn")&&console._ori.warn.apply(console,e)}),c.error=((...e)=>{r("error")&&console._ori.error.apply(console,e)}),c.time=((...e)=>{global.Env.enableLogTime&&r("info")&&console._ori.time&&console._ori.time.apply(console,e)}),c.timeEnd=((...e)=>{global.Env.enableLogTime&&r("info")&&console._ori.timeEnd&&console._ori.timeEnd.apply(console,e)})}},resetNativeConsole:function(){o={},global.console=t}};let l=null;function a(e){return"string"==typeof e?{uri:e}:"object"==typeof e?e:void 0}var i={setNativeRouter:function(){if(l=global.history){const{go:e,back:t,push:n,replace:o}=l;global.history._ori={go:e,back:t,push:n,replace:o},global.history.go=((...e)=>{global.history._ori.go.apply(global.history,e)}),global.history.back=(()=>{global.history._ori.back.apply(global.history)}),global.history.forward=(()=>{}),global.history.push=((...e)=>{const t=a(e);t&&global.history._ori.push.apply(global.history,t)}),global.history.replace=((...e)=>{const t=a(e);t&&global.history._ori.replace.apply(global.history,t)})}else global.history={go:function(...e){},back:function(...e){},forward:function(...e){},push:function(...e){},replace:function(...e){}}},resetNativeRouter:function(){global.history=l}};let c=null,u=null,p=null,d=null,h=null,f=null,g=null,m=null,b=null;var v={setNativeConsole:s.setNativeConsole,resetNativeConsole:s.resetNativeConsole,setNativeTimer:function(){c=global.setTimeout,u=global.setInterval,p=global.requestAnimationFrame,d=global.clearTimeout,h=global.setTimeoutNative,f=global.clearInterval,g=global.setIntervalNative,m=global.cancelAnimationFrame,b=global.requestAnimationFrameNative;const e={};let t=0;"function"==typeof h&&(global.setTimeoutWrap=function(n,o,r){return e[++t]=o,global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### setTimeoutWrap ${t}----`),h(n,t,r),t},global.setTimeout=function(e,t){return global.setTimeoutWrap(-1,e,t)},global.setTimeoutCallback=function(t){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### setTimeout 执行回调 ${t}----`),"function"==typeof e[t]&&(e[t](),delete e[t])},global.clearTimeout=global.clearTimeoutWrap=function(t){"function"==typeof d&&d(t),"function"==typeof e[t]?delete e[t]:e[t]=void 0}),"function"==typeof g&&(global.setIntervalWrap=function(n,o,r){return e[++t]=o,global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### setIntervalWrap ${t}----`),g(n,t,r),t},global.setInterval=function(e,t){return global.setIntervalWrap(-1,e,t)},global.setIntervalCallback=function(t){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### setInterval 执行回调 ${t}----`),"function"==typeof e[t]&&e[t]()},global.clearInterval=global.clearIntervalWrap=function(t){"function"==typeof f&&f(t),"function"==typeof e[t]?delete e[t]:e[t]=void 0}),"function"==typeof b&&(global.requestAnimationFrameWrap=function(n,o){return e[++t]=o,global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### requestAnimationFrame ${t}----`),b(n,t),t},global.requestAnimationFrame=function(e){return global.requestAnimationFrameWrap(-1,e)},global.requestAnimationFrameCallback=function(n){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### requestAnimationFrame 执行回调 ${t}----`),"function"==typeof e[n]&&e[n]()},global.cancelAnimationFrame=global.cancelAnimationFrameWrap=function(t){"function"==typeof m&&m(t),"function"==typeof e[t]?delete e[t]:e[t]=void 0})},resetNativeTimer:function(){global.setTimeout=c,global.clearTimeout=d,global.clearTimeoutWrap=null,global.setTimeoutCallback=null,global.setTimeoutWrap=null,global.setInterval=u,global.clearInterval=f,global.clearIntervalWrap=null,global.setIntervalCallback=null,global.setIntervalWrap=null,global.requestAnimationFrame=p,global.cancelAnimationFrame=m,global.cancelAnimationFrameWrap=null,global.requestAnimationFrameCallback=null,global.requestAnimationFrameWrap=null},setNativeRouter:i.setNativeRouter,resetNativeRouter:i.resetNativeRouter,freezePrototype:function(){Object.freeze(Object),Object.freeze(Array),Object.freeze(Object.prototype),Object.freeze(Array.prototype),Object.freeze(String.prototype),Object.freeze(Number.prototype),Object.freeze(Boolean.prototype),Object.freeze(Error.prototype),Object.freeze(Date.prototype),Object.freeze(RegExp.prototype)}};function y(e,t,n){return"function"==typeof global.compileAndRunScript?function(e,t,n){let o="(function (";const r=[],s=[];for(const t in e)r.push(t),s.push(e[t]);for(let e=0;e<r.length-1;++e)o+=r[e],o+=",";o+=r[r.length-1],o+=") {",o+=t,o+="} )";const l=global.compileAndRunScript(o,n);return l&&"function"==typeof l?l(...s):l}(e,t,n):function(e,t){const n=[],o=[];for(const t in e)n.push(t),o.push(e[t]);return n.push(t),new Function(...n)(...o)}(e,t)}function E(e){const t=Object.prototype.toString.call(e);return t.substring(8,t.length-1).toLowerCase()}function _(e){const t=Object.create(null);return function(n){return t[n]||(t[n]=e(n))}}const N=/-(\w)/g,w=_(e=>e.replace(N,A));function A(e,t){return t?t.toUpperCase():""}const C=/([a-z\d])([A-Z])/g,S=_(e=>e.replace(C,"$1-$2").toLowerCase());function $(...e){const t=e.reduce((e,t)=>e.concat(t),[]);return Array.from(new Set(t))}function T(e){return null!==e&&"object"==typeof e}let O=0;function k(){return++O}const L={},I={};let P={};const R={MODE:{SYNC:0,CALLBACK:1,SUBSCRIBE:2},TYPE:{METHOD:0,ATTRIBUTE:1,EVENT:2},NORMALIZE:{RAW:0,JSON:1},RESULT:{MODULE_INST:0}};function F(e,t,n){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### require模块：${t}`);const o=[t];let r,s={};if(t.indexOf(".")<0){const e=t+".";for(const t in H())t.startsWith(e)&&o.push(t)}if(o.forEach(o=>{const l=H()[o];if(!l)return;let a=o.replace(t,"");if("."===a.substr(0,1)&&(a=a.substr(1)),l.instantiable){const e=function(...t){const n=e.__init__(...t);Object.defineProperty(this,"_instId",{enumerable:!1,configurable:!1,writable:!1,value:n&&n.instId})};if(0===a.length)s=e;else{const t=a.split(".");if(t.length>0){const n=t.pop();x(s,t)[n]=e}}}if(o===t)r=s;else if(a.length>0){const e=a.split(".");e.length>0&&(r=x(s,e))}!function(e,t,n,o){const r=n.methods;for(const s in r){const l=r[s],a=l.instanceMethod?t.prototype:t;s in a&&console.warn(`### App Framework ### 模块${n.name}的接口函数${s}---- 重复定义`);const i=function(...t){if(e._isApp&&!e._defined)throw new Error(`请确认Native方法调用[${n.name}.${s}()]发生在应用app的生命周期的创建['onCreate()']之后`);const r=Object.prototype.hasOwnProperty.call(this,"_instId")?this._instId:o;return D(e,n,l,t,r)};Object.defineProperty(a,s,{configurable:!1,enumerable:!0,get(){return i.bind(this)},set(e){console.warn(`### App Framework ### 接口${n.name}的方法(${s})为可读，不可覆盖`)}}),global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### require---- 模块${n.name}接口函数${s}`)}const s=n.attributes;for(const e in s){const o=s[e],r=o.instanceMethod?t.prototype:t;Object.defineProperty(r,e,{configurable:!1,enumerable:!0,get(){if(o[1])return this[o[1].name]();console.warn(`### App Framework ### 模块${n.name}的接口属性(${e})不可读`)},set(t){o[2]?this[o[2].name]({value:t}):console.warn(`### App Framework ### 模块${n.name}的接口属性(${e})不可写`)}})}const l=n.events;for(const e in l){const o=l[e];o.cache=o.cache||{};const r=o.instanceMethod?t.prototype:t;Object.defineProperty(r,e,{configurable:!1,enumerable:!0,get(){const e=void 0===this._instId?-1:this._instId;return o.cache[e]},set(t){if("function"!=typeof t&&-1===[null,void 0].indexOf(t))console.warn(`### App Framework ### 模块${n.name}的接口事件(${e})值类型必须是函数或null`);else{const e=void 0===this._instId?-1:this._instId,n="function"==typeof t?t.bind(this):t;this[o.name]({success:n}),o.cache[e]=t}}})}}(e,r,l,n)}),0===Object.keys(s).length)throw new Error(`请确认引入的模块[${t}]：名称正确并且在manifest.json的features中声明`);return s}function x(e,t){if(!e)return;let n=e;return t.forEach(e=>{e in n||(n[e]={}),n=n[e]}),n}const M=["success","cancel","fail","complete"];function D(e,t,n,o,r){const{name:s,type:l}=t,{name:a,mode:i,type:c,normalize:u}=n;if(!e._callbacks)return console.warn(`### App Framework ### 容器已销毁,接口调用(${s}.${a}())无效`),new Error("invokeNative: 容器已销毁");if("feature"===l&&!global.JsBridge)return new Error("invokeNative: JsBridge没有初始化");if("module"===l&&!global.ModuleManager)return new Error("invokeNative: ModuleManager没有初始化");const p="feature"===l?global.JsBridge:global.ModuleManager,d=o.length>0?o[0]:{};d&&d.callback&&(d.success&&console.warn("### App Framework ### invoke函数不能同时出现'success'和'callback'参数"),d.success=d.callback);let h={};const f={};if(T(d))for(const t in d){const n=d[t];M.indexOf(t)>=0?"function"==typeof n?f[t]=n:console.warn(`### App Framework ### invoke函数的回调参数${t}类型不是function`):"callback"!==t&&(u===R.NORMALIZE.JSON?h[t]=B(n,e):h[t]="function"==typeof t?B(n,e):n)}else"function"==typeof d?f.success=d:h=d;if(u===R.NORMALIZE.JSON&&(h=JSON.stringify(h)),i===R.MODE.SYNC){const n=p.invoke(s,a,h,"-1",r);return null==n?void console.warn(`### App Framework ### invoke函数 '${s}.${a}' 返回值为null`):(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### invoke函数 '${s}.${a}' 调用成功，返回值为: ${n}`),j(e,n,t,a).data)}{let n,o,l;c===R.TYPE.METHOD&&i===R.MODE.CALLBACK&&(f.flagCallback=!0);const u=[];if(Object.keys(f).length){const r=global.isRpkMinPlatformVersionGEQ(1040)?void 0:f,s=k();e._callbacks[s]=(s=>{const i=f,c=j(e,s,t,a),u=c.code,p=c.data;0===u&&i.success?i.success.call(r,p):100===u&&i.cancel?i.cancel.call(r):u>=200&&i.fail&&i.fail.call(r,p,u),i.complete&&i.complete.call(r,p),n&&(0===u?o({data:p}):l({data:p,code:u}))}),L[s]={instance:e.id.toString(),preserved:i===R.MODE.SUBSCRIBE},u.push(h),u.push(s.toString())}else u.push(h),u.push("-1");if(p.invoke(s,a,...u,r),c===R.TYPE.METHOD&&i===R.MODE.CALLBACK&&1===Object.keys(f).length)return n=new Promise((e,t)=>{o=e,l=t})}}function j(e,t,n,o){const r="string"==typeof t?JSON.parse(t):t||{},s=r.content;return s&&s._nativeType===R.RESULT.MODULE_INST?(n.instantiable&&"__init__"===o?r.data=s:r.data=F(e,s.name,s.instId),e._nativeInstList&&e._nativeInstList.push(t)):r.data=s,r}function B(e,t){switch(E(e)){case"undefined":case"null":return"";case"regexp":return e.toString();case"date":return e.toISOString();case"number":case"string":case"boolean":case"array":case"object":return e;case"function":const n=k();return t._callbacks?t._callbacks[n]=e:global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### normalize() inst实例已经销毁，不再注册回调"),L[n]={instance:t.id.toString(),preserved:!1},n.toString();default:return JSON.stringify(e)}}function J(e,t){I[e]=t}function H(){return P}class W{constructor(e){this.id=e,this._callbacks={},this._nativeInstList=[],J(e,this)}invoke(e,t,n,o){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 调用对象(${e.id})的回调(${t}) 参数：`,JSON.stringify(n));const r=e._callbacks[t];if("function"==typeof r){const s=r(n);return void 0!==o&&!1!==o||(e._callbacks[t]=void 0),s}return new Error(`invoke: 无效invoke回调函数Id "${t}"`)}destroy(){this._callbacks=null,this._nativeInstList=null,J(this.id,null)}}let z={};const G={};class U{constructor(e="message",t={}){this.type=e,this.data=t.data||null,this.timeStamp=Date.now()}}const q={};function V(e,t=null){q[e]=t}var Y={init:function(){v.setNativeConsole(),v.setNativeTimer(),v.setNativeRouter()},exposeToNative:function(e){for(const t in e)global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### 注册全局函数----",t),global[t]=((...n)=>{const o=e[t](...n);return o instanceof Error&&console.error(o.toString()),o})},defineBundle:V,requireBundle:function(e){if(e=e.replace(/\.js$/,""),!q[e]){let t=global.readResource(`assets:///js/bundles/${e}.js`);"string"==typeof t&&(t=y({},`${t}; return ${e}`,`/bundles/${e}.js`)),V(e,t)}return q[e]},loadResource:function(e){return global.readResource(e)},BroadcastChannel:class{constructor(e){if(global.Env.engine===global.ENGINE_TYPE.CARD)throw new Error("BroadcastChannel is not supported.");Object.defineProperty(this,"name",{configurable:!1,enumerable:!0,writable:!1,value:String(e)}),this._closed=!1,this.onmessage=null,G[this.name]||(G[this.name]=[]),G[this.name].push(this)}postMessage(e){if(this._closed)throw new Error(`BroadcastChannel "${this.name}" is closed.`);const t=G[this.name];if(t&&t.length)for(let n=0;n<t.length;++n){const o=t[n];o._closed||o===this||"function"==typeof o.onmessage&&o.onmessage(new U("message",{data:e}))}}close(){if(!this._closed&&(this._closed=!0,G[this.name])){const e=G[this.name].indexOf(this);e>-1?G[this.name].splice(e,1):delete G[this.name]}}},ENGINE_TYPE:{PAGE:"page",CARD:"card"},ModuleHost:W,requireModule:F,exposure:{registerModules:function(e,t="feature"){"string"==typeof e&&(e=JSON.parse(e)),global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### registerModules---- ",JSON.stringify(e)),"object"==typeof(e=e.map(function(e){return e.__type__=t,e}))&&function(e,t=!0){let n=[];Array.isArray(e)?n=e:n.push(e),n.forEach(e=>{const n=e.name;global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 注册模块---- ${n} <${e.__type__}>`);let o=P[n];o||(o={type:e.__type__,name:e.name,methods:{},attributes:{},events:{},instantiable:e.instantiable},P[n]=o),o.methods||(o.methods={});const r=o.methods;e.methods&&e.methods.length&&e.methods.forEach(e=>{const s=e.name;if(void 0===e.mode&&(e.mode=R.MODE.SYNC),void 0===e.type&&(e.type=R.TYPE.METHOD),void 0===e.normalize&&(e.normalize=R.NORMALIZE.JSON),void 0===e.instanceMethod&&(e.instanceMethod=!1),!o.instantiable&&e.instanceMethod)throw new Error(`模块 ${o.name} 配置定义错误`);if(e.type===R.TYPE.ATTRIBUTE){const t=e.alias,n=e.access;o.attributes[t]=o.attributes[t]||{},o.attributes[t][n]=e,o.attributes[t].instanceMethod=e.instanceMethod}else if(e.type===R.TYPE.EVENT){const t=e.alias;o.events[t]=e}s?r[s]&&!t||(r[s]=e,global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 注册模块 ${n} 接口---- ${s}`)):console.warn(`### App Framework ### 模块 ${n} 的接口没有name属性`)})})}(e)},execInvokeCallback:function(e){"string"==typeof e&&(e=JSON.parse(e));const t=function(e){const t=L[e];return t&&!0===t.preserved||(L[e]=void 0),t}(e.callback);if(global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### 处理invoke回调----",JSON.stringify(t)),t){const n=function(e){return I[e]}(t.instance);if(n){const o=[n,e.callback,e.data,t.preserved];return n._callbacks?n.invoke(...o):new Error(`execInvokeCallback: 回调函数所属对象已经无效 "${n.id}"`)}}return new Error(`execInvokeCallback: 无效invoke回调Id "${t&&t.instance}"`)},registerManifest:function(e){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 注册manifest信息：${JSON.stringify(e)}`),"string"==typeof e&&(e=JSON.parse(e)),z=e||{}},getManifestField:function(e){const t=e.split(".");let n=z;for(let e=0,o=t.length;e<o&&null!=(n=n[t[e]]);e++);return n},isRpkMinPlatformVersionGEQ:function(e){return z.minPlatformVersion>=e}}};class K{constructor(e,t={bubbles:!1,cancelable:!1}){if(arguments.length>1&&"object"!=typeof t)throw new Error(`### App Runtime ### addEventListener() 参数2传递的话，必须是对象：${t}`);this._type=e,this._bubbles=t.bubbles,this._cancelable=t.cancelable,this._target=null,this._currentTarget=null,this._eventPhase=K.NONE,this._defaultPrevented=!1,this._timeStamp=Date.now(),this._supportW3C=!0,this._flagStopPropagation=!1,this._flagStopImmediatePropagation=!1}get type(){return this._type}get bubbles(){return this._bubbles}get cancelable(){return this._cancelable}get target(){return this._target}get currentTarget(){return this._currentTarget}get eventPhase(){return this._eventPhase}get defaultPrevented(){return this._defaultPrevented}get timeStamp(){return this._timeStamp}stopPropagation(){this._flagStopPropagation=!0}stopImmediatePropagation(){this._flagStopImmediatePropagation=!0,this.stopPropagation()}preventDefault(){throw new Error("### App Runtime ### preventDefault() 暂不支持该方法")}toJSON(){return{type:this._type,target:this._target,currentTarget:this._currentTarget,timeStamp:this._timeStamp}}}K.NONE=0,K.CAPTURING_PHASE=1,K.AT_TARGET=2,K.BUBBLING_PHASE=3;class X extends K{constructor(){super(...arguments),this._touches=null,this._changedTouches=null}get touches(){return this._touches}set touches(e){if(this._touches)throw new Error("### App Framework ### TouchEvent 不支持修改 touches 属性");this._touches=e}get changedTouches(){return this._changedTouches}set changedTouches(e){if(this._changedTouches)throw new Error("### App Framework ### TouchEvent 不支持修改 changedTouches 属性");this._changedTouches=e}toJSON(){const e=super.toJSON();return Object.assign(e,{touches:this._touches,changedTouches:this._changedTouches})}}const Z={HTML_ID:"-1"},Q={UNKNOWN:0,ELEMENT:1,ATTR:2,TEXT:3,COMMENT:8,DOCUMENT:9,DOCUMENT_FRAGMENT:11,FIGMENT:101};let ee=1;class te{constructor(){this._nodeType=te.NodeType.UNKNOWN,this._nodeName=null,this._nodeValue=null,this._ownerDocument=null,this._textContent=null,this.ref=(ee++).toString(),this.childNodes=[],this.layoutChildren=[],this.parentNode=null,this.nextSibling=null,this.previousSibling=null,this._docId=null,this._layout=!1,this._render=!1,this._renderCount=null}get nodeType(){return this._nodeType}get nodeName(){return this._nodeName}get nodeValue(){return this._nodeValue}get ownerDocument(){return this._ownerDocument}get textContent(){return this._textContent}set textContent(e){if(this.nodeType!==te.NodeType.TEXT){const t=this.ownerDocument.createTextNode(e);this.appendChild(t)}else this._textContent=e}}te.NodeRef=Z,te.NodeType=Q;const ne={};function oe(e){return ne[e]}function re(e){const t=oe(e);return t&&t.listener?t.listener:null}function se(e,t){if(e._docId===t)return;const n=oe(t);if(n){e._docId=t,n._nodeMap[e.ref]=e;for(let t=0,n=e.childNodes.length;t<n;t++)se(e.childNodes[t],e._docId)}}function le(e,t){return e._nodeMap[t]}function ae(e,t){e.parentNode=t,t._docId&&(se(e,t._docId),e._depth=t._depth+1);for(let t=0,n=e.childNodes.length;t<n;t++)ae(e.childNodes[t],e)}function ie(e,t,n,o){n<0&&(n=0);const r=t[n-1],s=t[n];return t.splice(n,0,e),o&&(r&&(r.nextSibling=e||null),e.previousSibling=r||null,e.nextSibling=s||null,s&&(s.previousSibling=e||null)),n}function ce(e,t,n){const o=t.indexOf(e);if(!(o<0)){if(n){const n=t[o-1],r=t[o+1];n&&(n.nextSibling=r||null),r&&(r.previousSibling=n||null),e.previousSibling=null,e.nextSibling=null}t.splice(o,1)}}function ue(e,t,n,o){const r=t.indexOf(e);if(r<0||r===n)return-1;ce(e,t,o);let s=n;return r<=n&&(s=n-1),ie(e,t,s,o),n}function pe(e,t){const n=oe(e);return n?n._styleSheetHash[t]:null}function de(e){const t=[];let n=e;const o=e._docId,r=oe(o)._styleSheetHash[0].map(e=>pe(o,e));for(t.push(...r),e._useParentStyle&&(n=e.parentNode);n&&!n._styleSheetId;)n=n.parentNode;if(n&&n._styleSheetId){const e=pe(o,n._styleSheetId);-1===t.indexOf(e)&&t.push(e)}return global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 获取节点(${e.ref}:${e._type})的样式表:${t.map(e=>e.id).join(",")}`),t}const he=/^data.+/;function fe(e,t){const n=[],o=Object.assign({},t);if(e)for(let t=0,r=e.length;t<r;t++){const r=e[t];o.hasOwnProperty(r.name)?(n.push({name:S(r.name),value:o[r.name],disabled:!1}),delete o[r.name]):r.disabled&&n.push({name:S(r.name),value:r.value,disabled:r.disabled})}for(const e in o)n.push({name:S(e),value:o[e],disabled:!1});return n}function ge(e){return(e||"").split(/\s+/).filter(e=>""!==e).filter((e,t,n)=>n.indexOf(e)===t)}const me={};function be(e){return me[e]}function ve(e){return e._attr}function ye(e){return e._style}function Ee(e){if(e._classList)return e._classList;const t=ve(e);return e._classList=ge(t.class),e._classList}function _e(e){return e._finalStyleCache=e._finalStyleCache||function(e,t){if(!t)return global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Runtime ### 计算节点CSS样式优先级 没有样式缓存对象，不再计算"),{};const n=Ne(t),o=n.map(e=>e.style);global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Runtime ### 按照优先级合并节点样式：",n.map(e=>`"${e.name}"`).join(" < "));const r=Object.assign({},...o),s=Object.keys(Object.assign({},e,r));for(let t=0,n=s.length;t<n;t++){const n=s[t];void 0!==r[n]&&void 0===e[n]?e[n]=!0:void 0===r[n]&&void 0!==e[n]&&(r[n]="")}return r}(e._usedCSSPropertyCache,e._matchedCssRuleCache),e._finalStyleCache}function Ne(e){const t=[];for(const n in e){const o=e[n];o&&o.length&&t.push.apply(t,o)}return t.sort((e,t)=>e.score.sum-t.score.sum),t}function we(e,t=!0){if(e.nodeType===Q.ELEMENT){const n={ref:e.ref.toString(),type:e._type},o=ve(e);if(o&&Object.keys(o).length){n.attr={};for(const e in o){const t=o[e];n.attr[e]=-1!==[null,void 0].indexOf(t)?"":t}}const r=_e(e);r&&Object.keys(r).length&&(n.style=r);const s=Object.keys(e._eventTargetListeners||{});if(s&&s.length&&(n.event=s),t&&e.layoutChildren&&e.layoutChildren.length){const t=[];for(let n=0,o=e.layoutChildren.length;n<o;n++){const o=e.layoutChildren[n],r=we(o);Ce(o)?t.push(r):t.push.apply(t,r)}n.children=t}return n}if(e.nodeType===Q.FIGMENT){const n=[];if(t&&e.layoutChildren&&e.layoutChildren.length)for(let t=0,o=e.layoutChildren.length;t<o;t++){const o=e.layoutChildren[t],r=we(o);o.nodeType===Q.FIGMENT?n.push.apply(n,r):n.push(r)}return n}if(e.nodeType===Q.COMMENT)return[];global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### getNodeAsJSON() 忽略该类型(${e.nodeType})的节点序列化`)}function Ae(e){return e._layout}function Ce(e){return e._render}function Se(e,t=!1){let n=t?e:e.parentNode;for(;n&&!Ce(n);)n=n.parentNode;return n}function $e(e,t=!1){const n=[];let o=Se(e,t);for(;o;)n.push(o),o=Se(o);return n}function Te(e){if(null!==e._renderCount)return e._renderCount;let t=Ce(e)?1:0;if(Ae(e)&&!Ce(e))for(let n=0,o=e.layoutChildren.length;n<o;n++)t+=Te(e.layoutChildren[n]);return e._renderCount=t,t}function Oe(e){let t=e;for(;t;)t._renderCount=null,t=t.parentNode}function ke(e){const t=e.parentNode;if(e.nodeType===Q.DOCUMENT||e.ref===Z.HTML_ID)return 0;if(!t||!Ae(e))return-1;const n=Le(e,t);let o=0;return Ce(t)||(o=ke(t)),n<0||o<0?-1:n+o}function Le(e,t){if(!t.layoutChildren||t.layoutChildren.length<=0)return-1;const n=t.layoutChildren.indexOf(e);if(n>0){let e=0;for(let o=0,r=n;o<r;o++)e+=Te(t.layoutChildren[o]);return e}return n}function Ie(e){delete e._depth,delete e._tmpRenderIndexInParent,delete e._eventTargetListeners,delete e._bindWatcherList,delete e._vm,function(e){if(delete e._docId,delete e._layout,delete e._render,delete e._renderCount,delete e.nextSibling,delete e.previousSibling,delete e.parentNode,e.childNodes)for(let t=e.childNodes.length-1;t>=0;t--)Pe(e.childNodes[t]);delete e.layoutChildren,delete e.childNodes,delete e._content,delete e._ownerDocument,global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 销毁节点：节点(${e.ref})剩余属性有：[${Object.keys(e).join(", ")}]`)}(e)}function Pe(e){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 销毁元素：${JSON.stringify(we(e,!1))}`),delete e._classList,delete e._styleSheetId,delete e._useParentStyle,delete e._usedCSSPropertyCache,delete e._matchedCssRuleCache,delete e._finalStyleCache,delete e._ownCssRuleCache,delete e._attr,delete e._style,delete e._dataset,Ie(e)}function Re(e,t,n){n instanceof Object||(n={capture:!!n});const o=t.type,r=e._eventTargetListeners[o],s=n.capture?K.CAPTURING_PHASE:K.BUBBLING_PHASE;if(r&&r[s]&&r[s].list){const n=r[s].list;for(let o=0,r=n.length;o<r;o++){const r=n[o];t._target=e,global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### fireTargetEventListener() 事件响应:${t.type}，节点:${e.ref}`),r&&r.call(t.target,t)}}}class Fe extends te{constructor(){super(...arguments),this._eventTargetListeners={}}addEventListener(e,t,n){if(arguments.length<2)throw new Error(`### App Runtime ### addEventListener() 至少需要传递两个参数:${arguments.length}`);if("string"!=typeof e)throw new Error("### App Runtime ### addEventListener() 参数1必须是字符串，事件类型");if("function"!=typeof t)throw new Error("### App Runtime ### addEventListener() 参数2必须是函数，监听事件");global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### addEventListener() 节点(${this.ref})注册事件(${e})`),n instanceof Object||(n={capture:!!n,once:!1,passive:!1});const o=n.capture?K.CAPTURING_PHASE:K.BUBBLING_PHASE,r=this._eventTargetListeners[e]=this._eventTargetListeners[e]||{};if(r[o]=r[o]||{},r[o].list=r[o].list||[],r[o].hash=r[o].hash||{},-1===r[o].list.indexOf(t)){const e=r[o].list.push(t);r[o].hash[e-1]={capture:!!n.capture,once:!!n.once,passive:!!n.passive}}const s=re(this._docId);s&&s.addEvent(this.ref,e)}removeEventListener(e,t,n){if(arguments.length<2)throw new Error(`### App Runtime ### addEventListener() 至少需要传递两个参数:${arguments.length}`);if("string"!=typeof e)throw new Error("### App Runtime ### addEventListener() 参数1必须是字符串，事件类型");if("function"!=typeof t)throw new Error("### App Runtime ### addEventListener() 参数2必须是函数，监听事件");global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### Element ${this.ref} 执行 removeEventListener(${e})---- `),n instanceof Object||(n={capture:!!n});const o=n.capture?K.CAPTURING_PHASE:K.BUBBLING_PHASE,r=this._eventTargetListeners[e]=this._eventTargetListeners[e]||{};r[o]=r[o]||{},r[o].list=r[o].list||[],r[o].hash=r[o].hash||{};const s=r[o].list.indexOf(t);-1!==s&&(r[o].list.splice(s,1),r[o].hash[s]=null),0===r[o].list.length&&(r[o]=null)}dispatchEvent(e){if(!(e instanceof K))throw new Error("### App Runtime ### dispatchEvent() 参数1所属类必须是事件类");if(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### dispatchEvent() 执行事件:${e.type}, 来自节点:${this.ref}`),!e._supportW3C)return Re(this,e);e._target=this;const t=e.type,n=$e(this,!0),o=n.slice().reverse().concat(n);if(o[0]&&o[0].parentNode===o[0].ownerDocument){const e=o[0].ownerDocument;o.unshift(e),o.push(e)}for(;o.length>0;){const n=o[0],r=o.indexOf(n),s=o.indexOf(this);if(e._eventPhase=r<s?K.CAPTURING_PHASE:r===s?K.AT_TARGET:K.BUBBLING_PHASE,e._currentTarget=n,!e.bubbles&&e.eventPhase===K.BUBBLING_PHASE)break;global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### dispatchEvent() 执行事件:${t}, 阶段:${e.eventPhase}, Target:${e.target.ref}, CurrentTarget:${e.currentTarget.ref}`);const l=n._eventTargetListeners[t];let a=e.eventPhase;if(e.target===e.currentTarget&&(a=n===o[1]?K.CAPTURING_PHASE:K.BUBBLING_PHASE),l&&l[a]&&l[a].list){const t=l[a].hash,o=l[a].list.slice();for(let r=0,s=o.length;r<s&&!e._flagStopImmediatePropagation;r++){const s=o[r];try{global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### dispatchEvent() 事件响应:${e.type}，阶段:${e.eventPhase}`),s&&s.call(e.currentTarget,e)}catch(t){console.error(`### App Runtime ### dispatchEvent() 事件响应:${e.type}，阶段:${e.eventPhase}, JS报错:`,t.message,s),console.error(t.stack)}t[r]&&t[r].once&&n.removeEventListener(e.type,s,t[r])}}if(e._flagStopImmediatePropagation||e._flagStopPropagation)break;o.shift()}e._currentTarget=null}}const xe={TAG:1,CLASS:1e3,ID:1e6,STEP:1e6,INLINE:1e9},Me={TAG:1,CLASS:2,ID:3,DESC:4,INLINE:5},De={name:null,type:null,score:null,order:0,style:null,_sheetId:null,_hitNodeMap:null,_styleFullList:null};function je(e){const t=Object.assign({},De,{type:Me.TAG,score:{self:xe.TAG,depth:1},_hitNodeMap:{}},e);return t.score.sum=t.score.self*xe.STEP+t.order,t}function Be(e){const t=Object.assign({},De,{type:Me.CLASS,score:{self:xe.CLASS,depth:1},_hitNodeMap:{}},e);return t.score.sum=t.score.self*xe.STEP+t.order,t}function Je(e){const t=Object.assign({},De,{type:Me.ID,score:{self:xe.ID,depth:1},_hitNodeMap:{}},e);return t.score.sum=t.score.self*xe.STEP+t.order,t}function He(e){const t=Object.assign({},De,{type:Me.DESC,_hitNodeMap:{}},e);return t.score=function(e,t){const n={id:0,class:0,tag:0,self:0,depth:1};for(let t=0,o=e.length;t<o;t++){const o=e[t];We(o)?n.tag+=1:Ge(o)?n.id+=1:ze(o)?n.class+=1:Ue(o)&&(n.depth+=1)}return n.self=n.id*xe.ID+n.class*xe.CLASS+n.tag*xe.TAG,{self:n.self,depth:n.depth}}(t.meta.ruleDef,t.order),t.score.sum=t.score.self*xe.STEP+t.order,t}function We(e){return"tag"===e.type}function ze(e){return"attribute"===e.type&&"class"===e.name}function Ge(e){return"attribute"===e.type&&"id"===e.name}function Ue(e){return"descendant"===e.type||"child"===e.type}function qe(e,t){let n;switch(e.type){case Me.TAG:n={match:e.name===t._type,matchChanged:!1,pathChanged:!1};break;case Me.CLASS:n={match:-1!==Ee(t).indexOf(e.name.substring(1)),matchChanged:!1,pathChanged:!1};break;case Me.ID:n={match:ve(t).id===e.name.substring(1),matchChanged:!1,pathChanged:!1};break;case Me.DESC:n=function(e,t){const n=e.meta.ruleDef,o=[];let r=[t];for(let s=n.length-1;s>=0;s--){const l=n[s],a=s===n.length-1;if(0===(r=Ye(l,r)).length||t._depth<e.score.depth)return Ve(e,t,!1,[]);a||-1!==["descendant","child"].indexOf(l.type)||o.push(r[0].ref)}return Ve(e,t,!0,o)}(e,t);break;default:throw new Error(`不支持的CSS规则类型：${e.type}`)}return n.match?function(e,t){e._hitNodeMap[t]=!0}(e,t.ref):function(e,t){delete e._hitNodeMap[t]}(e,t.ref),n}function Ve(e,t,n,o){const r={match:n,matchChanged:null,pathChanged:null};if(n){const n=t._ownCssRuleCache[e.order];n?n.join(",")===o.join(",")?(r.matchChanged=!1,r.pathChanged=!1):(r.matchChanged=!1,r.pathChanged=!0):(r.matchChanged=!0,r.pathChanged=!0),t._ownCssRuleCache[e.order]=o}else{t._ownCssRuleCache[e.order]?(r.matchChanged=!0,r.pathChanged=!0):(r.matchChanged=!1,r.pathChanged=!1),t._ownCssRuleCache[e.order]=null}return global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 节点(${t._type}:${t.ref})与后代CSS规则(${e.name})的匹配计算：${JSON.stringify(r)}`),r}function Ye(e,t){const n=e.type;switch(n){case"attribute":return function(e,t){if(ze(e)){const n=t.find(t=>-1!==Ee(t).indexOf(e.value));return n?[n]:[]}if(Ge(e)){const n=t.find(t=>ve(t).id===e.value);return n?[n]:[]}return console.warn(`### App Runtime ### 未知的CSS Selector规则：${e.name}，当前支持：class, id`),[]}(e,t);case"tag":return function(e,t){const n=t.find(t=>t._type===e.name);return n?[n]:[]}(e,t);case"descendant":return function(e,t){const n=[];for(let e=0,o=t.length;e<o;e++){const o=t[e];n.push.apply(n,$e(o))}return n}(0,t);case"child":return function(e,t){const n=[];for(let e=0,o=t.length;e<o;e++){const o=t[e],r=Se(o);r&&n.push(r)}return n}(0,t);default:return console.warn(`### App Runtime ### 未知的CSS Selector规则：${n}，当前支持：tag, class, id, 后代, '>'`),[]}}function Ke(e,t){if(!oe(e._docId))return void(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### calcNodeStyle() 节点(${e.ref}:${e._type})暂无关联document`));if(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### calcNodeStyle() 节点(${e.ref}:${e._type})计算类型：${t}`),e._finalStyleCache=null,!t||t===Me.INLINE){const t=e._matchedCssRuleCache[Me.INLINE];e._matchedCssRuleCache[Me.INLINE]=t||[]}let n,o,r,s,l;t&&t!==Me.TAG||(e._matchedCssRuleCache[Me.TAG]=[]),t&&t!==Me.CLASS||(e._matchedCssRuleCache[Me.CLASS]=[]),t&&t!==Me.ID||(e._matchedCssRuleCache[Me.ID]=[]);const a=ye(e);if((!t||t===Me.INLINE)&&((n=e._matchedCssRuleCache[Me.INLINE]).length?n[0].style=a:n.push(function(e){const t=Object.assign({},De,{name:"INLINE",type:Me.INLINE,score:{self:xe.INLINE},_hitNodeMap:{}},e);return t.score.sum=t.score.self*xe.STEP+t.order,t}({style:a})),t===Me.INLINE))return;const i=de(e);for(let a=0,c=i.length;a<c;a++){const c=i[a],u=(c.id,c.nameHash),p=c.descLast;if(!t||t===Me.TAG){n=e._matchedCssRuleCache[Me.TAG];const t=e._type;if(l=!1)n.push.apply(n,l);else{o=r=[],u.hasOwnProperty(t)&&(o=Xe([u[t]],e));const l=p[t]&&p[t].list||[];l.length>0&&(r=Ze(l,e)),s=o.concat(r),n.push.apply(n,s)}}const d=Ee(e);if(d.length>0&&(!t||t===Me.CLASS)){n=e._matchedCssRuleCache[Me.CLASS];const t=d.map(e=>`.${e}`);for(let a=0,i=t.length;a<i;a++){const i=t[a];if(l=!1)n.push.apply(n,l);else{if(o=r=[],u.hasOwnProperty(i)&&(o=Xe([u[i]],e)),p[i]){r=Ze(p[i].list||[],e)}s=o.concat(r),n.push.apply(n,s)}}}if(ve(e).id&&(!t||t===Me.ID)){n=e._matchedCssRuleCache[Me.ID];const t=ve(e).id,a=`#${t}`;if(l=!1)n.push.apply(n,l);else{o=r=[],t&&u.hasOwnProperty(a)&&(o=Xe([u[a]],e));const l=p[a]&&p[a].list||[];t&&l.length>0&&(r=Ze(l,e)),s=o.concat(r),n.push.apply(n,s)}}}}function Xe(e,t){const n=[];for(let o=0,r=e.length;o<r;o++){const r=e[o];qe(r,t).match&&n.push(r)}return n}function Ze(e,t){const n=[];for(let o=0;o<e.length;o++){const r=e[o];qe(r,t).match&&n.push(r)}return n}function Qe(e,t){const n=function(e,t){const n=de(e),o=[];for(let e=0,r=n.length;e<r;e++){const r=n[e],s=r.descNotLast;if(s[t]){const e=s[t].list;o.push(...e)}}return o}(e,t),o=[];for(let t=0,r=n.length;t<r;t++){const r=et(n[t],e);o.push(...r)}return $(o)}function et(e,t){const n=[];for(let o=0,r=t.layoutChildren.length;o<r;o++){const r=t.layoutChildren[o];if(Ce(r)){qe(e,r).matchChanged&&n.push(r.ref)}const s=et(e,r);n.push(...s)}return n}function tt(e){if(e.nodeType===te.NodeType.ELEMENT&&e._docId){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 添加到文档时计算节点(${e.ref}:${e._type})的样式`),Ke(e);for(let t=0,n=e.layoutChildren.length;t<n;t++)tt(e.layoutChildren[t])}}function nt(e,t,n){if(t.nodeType===te.NodeType.DOCUMENT_FRAGMENT){const o=t.childNodes.slice();for(let r=0,s=o.length;r<s;r++)t.removeChild(o[r]),nt(e,o[r],n);return t}const o=Se(e,!0),r=n?e.childNodes.indexOf(n):e.childNodes.length,s=re(e._docId);if(t.nodeType===te.NodeType.TEXT)throw new Error(`### App Runtime ### 不支持在非渲染节点中添加文本节点：${t.textContent}`);if(t.parentNode){if(ue(t,e.childNodes,r,!0),Ae(t))if(n){const r=ue(t,e.layoutChildren,e.layoutChildren.indexOf(n));Oe(e);const l=ke(t);if(s&&r>=0)return s.moveNode(t,o,l)}else{const n=ue(t,e.layoutChildren,e.layoutChildren.length);Oe(e);const r=ke(t);if(s&&n>=0)return s.moveNode(t,o,r)}}else if(ae(t,e),ie(t,e.childNodes,r,!0),tt(t),Ae(t))if(n){ie(t,e.layoutChildren,e.layoutChildren.indexOf(n)),Oe(e);const r=ke(t);if(s)return s.addNode(t,o,r)}else{ie(t,e.layoutChildren,e.layoutChildren.length),Oe(e);const n=e===o?-1:ke(t);if(s)return s.addNode(t,o,n)}}class ot extends Fe{constructor(){super(...arguments),this._depth=null,this._tmpRenderIndexInParent=null}appendChild(e){if(!(e&&e instanceof te))throw new Error("### App Runtime ### appendChild() 函数的node参数无效");if(e.parentNode&&e.parentNode!==this)throw new Error("### App Runtime ### appendChild() 参数node的父节点不匹配");return nt(this,e,null)}insertBefore(e,t){if(!(e&&2===arguments.length&&e instanceof te))throw new Error("### App Runtime ### insertBefore() 函数的node/before参数无效");if(e.parentNode&&e.parentNode!==this)throw new Error("### App Runtime ### insertBefore() 参数node的父节点不匹配");return e===t||e.nextSibling&&e.nextSibling===t?e:nt(this,e,t)}removeChild(e){if(!(e&&e instanceof te))throw new Error("### App Runtime ### removeChild() node参数无效");if(e.parentNode!==this)throw new Error("### App Runtime ### removeChild() 参数node的父节点不匹配");if(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### removeChild() 移除节点：${JSON.stringify(we(e))}`),Oe(e),e.parentNode=null,Ae(e)){if(Ce(e)){const t=re(e._docId);t&&t.removeElement(e.ref)}else{const t=e.childNodes.slice();for(let n=0;n<t.length;n++)e.removeChild(t[n])}ce(e,this.layoutChildren)}return ce(e,this.childNodes,!0),function e(t,n){if(t._docId!==n)return;const o=oe(n);if(o){for(let n=0,o=t.childNodes.length;n<o;n++)e(t.childNodes[n],t._docId);t._depth=null,o._nodeMap[t.ref]=null,t._docId=null}}(e,e._docId),e}toJSON(){return we(this)}}class rt extends ot{constructor(e){super(...arguments),this._nodeType=te.NodeType.COMMENT,this._nodeName="#comment",this._nodeValue=e,this._layout=!0,this._render=!1,this._data=e}get data(){return this._data}set data(e){const t=""+e;return this._nodeValue=t,this._data=t,this._data}appendChild(e){throw new Error("### App Runtime ### appendChild() 注释节点不支持插入子节点")}insertBefore(e,t){throw new Error("### App Runtime ### insertBefore() 注释节点不支持插入子节点")}toString(){return"\x3c!-- "+this._data+" --\x3e"}}function st(e,t,n,o){if(!e._ownerDocument||"ref"===t)return;if(!T(n)&&ve(e)[t]===n&&!1!==o)return;if("class"===t)e._classList=null;else if(he.test(t)){const o=t.replace(/[A-Z]/g,e=>"-"+e.toLowerCase()).replace(/^data-/,"").replace(/-([a-z])/g,(e,t)=>t.toUpperCase());e._dataset[o]=n}const r=ve(e)[t];ve(e)[t]=n,global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 元素的属性(${t})更新(${r}=>${n})`),at(e,o,t,n),function(e,t,n,o,r){const s=re(e._docId),l=oe(e._docId);if(!s)return;if(!l._supportNotLastRuleTypeUpdate)return;if(!ve(e).hasOwnProperty("descRestyling"))return;if(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 元素的属性(${n})更新(${r}=>${o})`),"class"===n){const t=ge(r),n=ge(o),s=function(e,t){const n={};return e.forEach(e=>n[e]=!0),t.forEach(e=>n[e]?delete n[e]:n[e]=!0),Object.keys(n)}(t,n).map(e=>`.${e}`),a=s.map(t=>Qe(e,t)),i=$(...a);for(let e=0,t=i.length;e<t;e++){const t=i[e],n=le(l,t);n&&(Ke(n),it(n))}}else if("id"===n){const t=r?Qe(e,`#${r}`):[],n=o?Qe(e,`#${o}`):[],s=$(t,n),a=s;for(let e=0,t=a.length;e<t;e++){const t=a[e],n=le(l,t);n&&(Ke(n),it(n))}}}(e,0,t,n,r)}function lt(e,t,n){if(!e._ownerDocument)return;if(t=t||"",ye(e)===t&&!1!==n)return;!function(e,t){e._style=t||{}}(e,"string"==typeof t?function(e){const t={};return e.split(";").filter(e=>e.trim()).forEach(e=>{const n=e.indexOf(":");let o=e.substring(0,n).trim();o=w(o);const r=e.substring(n+1).trim();t[o]=r}),global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 元素的样式转换：${e} 为${JSON.stringify(t)}`),t}(t):t),at(e,n,"style")}function at(e,t,n,o,r){const s=re(e._docId);s&&("class"===n?(Ke(e,Me.CLASS),!t&&s.setStyles(e.ref,_e(e),{class:o})):"id"===n?(Ke(e,Me.ID),!t&&s.setStyles(e.ref,_e(e),{id:o})):"style"===n?(Ke(e,Me.INLINE),r?!t&&s.setStyle(e.ref,...r):!t&&s.setStyles(e.ref,_e(e))):!t&&s.setAttr(e.ref,n,o))}function it(e){const t=re(e._docId);t&&t.setStyles(e.ref,_e(e))}function ct(e,t){const n=Ne(e._matchedCssRuleCache);return n.reverse(),t?n.filter(e=>e.name===t):n}class ut extends ot{constructor(e){super(...arguments),this._nodeType=te.NodeType.ELEMENT,this._nodeName=e.toUpperCase(),this._tagName=e.toUpperCase(),this._type=e,this._attr={},this._style={},this._dataset={},this._layout=!0,this._render=!0,this._classList=null,this._styleSheetId=null,this._useParentStyle=null,this._usedCSSPropertyCache={},this._matchedCssRuleCache={},this._finalStyleCache=null,this._ownCssRuleCache={}}get style(){return this._style}get type(){return console.warn("### App Runtime ### type属性将被废弃，不推荐使用"),this._type}get id(){console.warn("### App Runtime ### id属性将被废弃，不推荐使用");const e=ve(this);return e&&e.id}get dataset(){return this._dataset}get attr(){return console.warn("### App Runtime ### attr属性将被废弃，不推荐使用"),ve(this)}get tagName(){return this._tagName}appendChild(e){return e.nodeType===te.NodeType.TEXT?(st(this,"value",e.textContent),ae(e,this),e):super.appendChild(e)}insertBefore(e,t){return e.nodeType===te.NodeType.TEXT?(st(this,"value",e.textContent),ae(e,this),e):super.insertBefore(e,t)}hasAttribute(e){const t=ve(this);return t&&t.hasOwnProperty(e)}toString(){const e=ve(this),t=_e(this);return"<"+this._type+" attr="+JSON.stringify(e)+" style="+JSON.stringify(t)+">"+this.layoutChildren.map(e=>e.toString()).join("")+"</"+this._type+">"}}class pt extends ot{constructor(){super(...arguments),this._nodeType=te.NodeType.DOCUMENT_FRAGMENT,this._nodeName="#document-fragment",this._layout=!0,this._render=!1}}class dt extends ot{constructor(){super(...arguments),this._nodeType=te.NodeType.FIGMENT,this._nodeName="#figment",this._layout=!0,this._render=!1}toString(){let e="";return this.childNodes.length&&(e=this.childNodes.map(e=>e.toString()).join("")),e}}class ht extends ot{constructor(e){super(...arguments),this._nodeType=te.NodeType.TEXT,this._nodeName="#text",this._textContent=e,this._wholeText=e,this._layout=!1,this._render=!1}get wholeText(){return this._wholeText}appendChild(e){throw new Error("### App Runtime ### appendChild() 文本节点不支持插入子节点")}insertBefore(e,t){throw new Error("### App Runtime ### insertBefore() 文本节点不支持插入子节点")}}class ft extends ut{constructor(){super(...arguments),this.ref=te.NodeRef.HTML_ID,this._depth=0}appendChild(e){return function(e,t,n){if(e.layoutChildren.length>0||t.parentNode)return void console.warn("### App Runtime ### Document添加多个Body节点----");const o=oe(e._docId),r=e.childNodes,s=r.indexOf(n);s<0?r.push(t):r.splice(s,0,t),Ae(t)?(se(t,t._docId),ae(t,e),ie(t,e.layoutChildren,e.layoutChildren.length),Oe(e),tt(t),o.body=t,re(e._docId).createBody(t)):ae(t,e)}(this,e)}insertBefore(e,t){console.warn("### App Runtime ### 暂不支持nodeHtml.insertBefore()")}}class gt extends ut{get value(){return this._attr&&this._attr.value}set value(e){this._attr&&(this._attr.value=e)}get checked(){return this._attr&&this._attr.checked}set checked(e){this._attr&&(this._attr.checked=e)}}const mt=/^(touchstart|touchmove|touchcancel|touchend)$/,bt=/^(touchstart|touchmove|touchcancel|touchend|click|longpress)$/;function vt(e,t){let n;return mt.test(e)?(n=new X(e,t))._supportW3C=!1:(n=new K(e,t))._supportW3C=!1,bt.test(e)&&global.isRpkMinPlatformVersionGEQ(1040)&&(n._supportW3C=!0,n._bubbles=!0),n}function yt(e){const t=new ft("html");return t._ownerDocument=e,se(t,e._docId),t.parentNode=e,e.childNodes.push(t),e.layoutChildren.push(t),t}class Et extends ot{constructor(e,t){var n,o;super(...arguments),this._nodeType=te.NodeType.DOCUMENT,this._nodeName="#document",this.body=null,e=e?e.toString():"",this._docId=e,this._nodeMap={},this.listener=t,this._styleSheetHash={},this._styleSheetHash[0]=[],n=this._docId,o=this,n&&(ne[n]=o),Object.defineProperty(this,"documentElement",{configurable:!0,enumerable:!1,writable:!1,value:yt(this)}),this._supportNotLastRuleTypeUpdate=!0}createElement(e){let t;return(t="input"===e||"textarea"===e?new gt(e):new ut(e))._ownerDocument=this,t}createDocumentFragment(){const e=new pt;return e._ownerDocument=this,e}createTextNode(e){const t=new ht(e);return t._ownerDocument=this,t}createComment(e){const t=new rt(e);return t._ownerDocument=this,t}createEvent(e,t){return vt(e,t)}}var _t=function(e,t){var n=[];if(""!==(e=function e(t,n,o){var r,s,l,a,i=[],c=!1;function u(){var e=n.match(Nt)[0];return n=n.substr(e.length),It(e)}function p(e){for(;Pt(n.charAt(e));)e++;n=n.substr(e)}function d(e){for(var t=0;"\\"===n.charAt(--e);)t++;return 1==(1&t)}for(p(0);""!==n;)if(Pt(s=n.charAt(0)))c=!0,p(1);else if(s in St)i.push({type:St[s]}),c=!1,p(1);else if(","===s){if(0===i.length)throw new SyntaxError("empty sub-selector");t.push(i),i=[],c=!1,p(1)}else if(c&&(i.length>0&&i.push({type:"descendant"}),c=!1),"*"===s)n=n.substr(1),i.push({type:"universal"});else if(s in $t)n=n.substr(1),i.push({type:"attribute",name:$t[s][0],action:$t[s][1],value:u(),ignoreCase:!1});else if("["===s){if(n=n.substr(1),!(r=n.match(At)))throw new SyntaxError("Malformed attribute selector: "+n);n=n.substr(r[0].length),l=It(r[1]),o&&("lowerCaseAttributeNames"in o?!o.lowerCaseAttributeNames:o.xmlMode)||(l=l.toLowerCase()),i.push({type:"attribute",name:l,action:Ct[r[2]],value:It(r[4]||r[5]||""),ignoreCase:!!r[6]})}else if(":"===s){if(":"===n.charAt(1)){n=n.substr(2),i.push({type:"pseudo-element",name:u().toLowerCase()});continue}if(n=n.substr(1),l=u().toLowerCase(),r=null,"("===n.charAt(0))if(l in Tt){var h=(a=n.charAt(1))in kt;if(n=n.substr(h+1),n=e(r=[],n,o),h){if(n.charAt(0)!==a)throw new SyntaxError("unmatched quotes in :"+l);n=n.substr(1)}if(")"!==n.charAt(0))throw new SyntaxError("missing closing parenthesis in :"+l+" "+n);n=n.substr(1)}else{for(var f=1,g=1;g>0&&f<n.length;f++)"("!==n.charAt(f)||d(f)?")"!==n.charAt(f)||d(f)||g--:g++;if(g)throw new SyntaxError("parenthesis not matched");r=n.substr(1,f-2),n=n.substr(f),l in Ot&&((a=r.charAt(0))===r.slice(-1)&&a in kt&&(r=r.slice(1,-1)),r=It(r))}i.push({type:"pseudo",name:l,data:r})}else{if(!Nt.test(n))return i.length&&"descendant"===i[i.length-1].type&&i.pop(),Rt(t,i),n;l=u(),o&&("lowerCaseTags"in o?!o.lowerCaseTags:o.xmlMode)||(l=l.toLowerCase()),i.push({type:"tag",name:l})}return Rt(t,i),n}(n,e+"",t)))throw new SyntaxError("Unmatched selector: "+e);return n},Nt=/^(?:\\.|[\w\-\u00b0-\uFFFF])+/,wt=/\\([\da-f]{1,6}\s?|(\s)|.)/gi,At=/^\s*((?:\\.|[\w\u00b0-\uFFFF\-])+)\s*(?:(\S?)=\s*(?:(['"])([^]*?)\3|(#?(?:\\.|[\w\u00b0-\uFFFF\-])*)|)|)\s*(i)?\]/,Ct={__proto__:null,undefined:"exists","":"equals","~":"element","^":"start",$:"end","*":"any","!":"not","|":"hyphen"},St={__proto__:null,">":"child","<":"parent","~":"sibling","+":"adjacent"},$t={__proto__:null,"#":["id","equals"],".":["class","element"]},Tt={__proto__:null,has:!0,not:!0,matches:!0},Ot={__proto__:null,contains:!0,icontains:!0},kt={__proto__:null,'"':!0,"'":!0};function Lt(e,t,n){var o="0x"+t-65536;return o!=o||n?t:o<0?String.fromCharCode(o+65536):String.fromCharCode(o>>10|55296,1023&o|56320)}function It(e){return e.replace(wt,Lt)}function Pt(e){return" "===e||"\n"===e||"\t"===e||"\f"===e||"\r"===e}function Rt(e,t){if(e.length>0&&0===t.length)throw new SyntaxError("empty sub-selector");e.push(t)}const Ft=new WeakMap;function xt(e,t){if(!Ft.has(t)){const n=function(e,t){const n=Object.keys(t||{}),o={id:Mt++,name:e,from:0,size:0,nameHash:{},descLast:{},descNotLast:{}};o.from=Dt,o.size=n.length,Dt+=n.length;for(let e=0,r=n.length;e<r;e++){const r=n[e],s=t[r];let l;if(!s||"_"===r[0])continue;if(s.animationName){const e=Bt(s.animationName,t);e&&(s.animationKeyframes=e)}if(s.fontFamily){const e=Jt(s.fontFamily,t);e&&(s.fontFamilyDesc=e)}if(!s._meta&&jt.test(r)){try{const e=Wt(r),t=e[0];t.length>1&&(s._meta={},s._meta.ruleDef=t)}catch(e){console.warn(`### App Runtime ### 编译CSS后代选择器(${r})出错：${e.message}`);continue}global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 编译CSS后代选择器(${r})`)}if(s._meta&&s._meta.ruleDef){const e=s._meta.ruleDef;for(let t=0,n=e.length;t<n;t++){const n=e[t];We(n)?n.idtt=n.name:ze(n)?n.idtt=`.${n.value}`:Ge(n)&&(n.idtt=`#${n.value}`)}}global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 遍历样式节点(${o.id})的选择器(${r})：${JSON.stringify(s)}`);const a=Object.assign({},s),i=o.from+e;if(a._meta){const e=a._meta;delete a._meta,o.nameHash[r]=l=He({name:r,score:null,order:i,style:a,meta:e,_sheetId:o.id});const t=l.meta.ruleDef,n=t[t.length-1];for(let e=0,n=t.length;e<n-1;e++){const n=t[e];if(!Ue(n)){const e=n.idtt;o.descNotLast[e]=o.descNotLast[e]||{list:[]},o.descNotLast[e].list.push(l)}}if(!Ue(n)){const e=n.idtt;o.descLast[e]=o.descLast[e]||{list:[]},o.descLast[e].list.push(l)}}else{if("@KEYFRAMES"===r)continue;"#"===r[0]?o.nameHash[r]=l=Je({name:r,order:i,style:a,_sheetId:o.id}):"."===r[0]?o.nameHash[r]=l=Be({name:r,order:i,style:a,_sheetId:o.id}):o.nameHash[r]=l=je({name:r,order:i,style:a,_sheetId:o.id})}}return o}(e,t);Ft.set(t,n)}return Ft.get(t)}let Mt=1,Dt=1;const jt=/\s/;function Bt(e,t){const n=t["@KEYFRAMES"];if(n){const t=n[e];if(t)return JSON.stringify(t)}return null}function Jt(e,t){const n=t["@FONT-FACE"],o=e.replace(/["']+/g,"").split(","),r=[];return o.length>0?(o.forEach(e=>{(e=e.trim())&&(n&&n[e]?r.push(n[e]):r.push({fontName:e}))}),JSON.stringify(r)):null}const Ht=new Map;function Wt(e){return Ht.has(e)||Ht.set(e,_t(e)),Ht.get(e)}function zt(e,t=[]){return{module:"dom",method:e,args:t}}class Gt{constructor(e,t){this.id=e,this.streamer=t,this.actionLen=0}createFinish(e){global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Runtime ### createFinish---- ");const t=this.streamer.over(this.id,[zt("createFinish")],e);return this.resetActionLen(),t}updateFinish(e){global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Runtime ### updateFinish---- ");const t=this.streamer.over(this.id,[zt("updateFinish")],e);return this.resetActionLen(),t}createBody(e){const t=we(e),n=t.children;delete t.children;const o=[zt("createBody",[t])];return n&&o.push.apply(o,n.map(e=>zt("addElement",[t.ref,e,-1]))),this.addActions(o)}addNode(e,t,n){let o;if(t&&Ce(t)||console.error(`### App Runtime ### addNode的parent(${t.type})必须是可渲染节点`),n<0&&(n=-1),Ce(e))o=this.addElement(e,t.ref,n);else{let r=n;e.layoutChildren.every(e=>(o=Ce(e)?this.addElement(e,t.ref,r):this.addNode(e,t,r),r+=Te(e),-1!==o))}return o}addElement(e,t,n){return n>=0||(n=-1),this.addActions(zt("addElement",[t,we(e),n]))}removeNode(e){let t;return Ce(e)?t=this.removeElement(e.ref):e.layoutChildren.every(e=>-1!==(t=Ce(e)?this.removeElement(e.ref):this.removeNode(e))),t}removeElement(e){if(Array.isArray(e)){const t=e.map(e=>zt("removeElement",[e]));return this.addActions(t)}return this.addActions(zt("removeElement",[e]))}moveNode(e,t,n){let o;if(t&&Ce(t)||console.error("### App Runtime ### moveNode的parent必须是可渲染节点"),n>=0||(n=-1),Ce(e))o=this.moveElement(e.ref,t.ref,n);else{let r=n;e.layoutChildren.every(e=>(o=Ce(e)?this.moveElement(e.ref,t.ref,r):this.moveNode(e,t,r),r+=Te(e),-1!==o))}return o}moveElement(e,t,n){return this.addActions(zt("moveElement",[e,t,n]))}setProp(e,t,n){}setAttr(e,t,n){const o={attr:{}};return null==n?(console.warn(`### App Runtime ### 组件 ${e} 的属性 ${t} 被修改为 undefined/null, 自动修改为默认值或空值`),o.attr[t]=""):o.attr[t]=n,this.addActions(zt("updateAttrs",[e,o]))}setStyle(e,t,n){const o={style:{}};return null==n?(console.warn(`### App Runtime ### 组件 ${e} 的样式 ${t} 被修改为 undefined/null, 自动修改为默认值或空值`),o.style[t]=""):o.style[t]=n,this.addActions(zt("updateStyle",[e,o]))}setStyles(e,t,n){const o={attr:n};return t&&Object.keys(t).length&&(o.style=t),this.addActions(zt("updateStyle",[e,o]))}addEvent(e,t){return this.addActions(zt("addEvent",[e,t]))}removeEvent(e,t){return this.addActions(zt("removeEvent",[e,t]))}updatePageTitleBar(e){return this.addActions(zt("updateTitleBar",[e]))}exitFullscreen(){return this.addActions(zt("exitFullscreen",[]))}invokeComponentMethod(e,t,n,o){return this.addActions({component:e,ref:t,method:n,args:o})}addActions(e){Array.isArray(e)||(e=[e]),global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Runtime ### addActions---- ",JSON.stringify(e)),this.actionLen+=e.length,this.streamer.push(this.id,e)}hasActions(){return!!this.actionLen}resetActionLen(){this.actionLen=0}}class Ut{constructor(e,t){this.call=e,this.batchThreshold=void 0===t?50:t,this._boolDefineNextTick=!0,this.list=[]}push(e,t){let n;if(0===this.batchThreshold)this.list.push.apply(this.list,t);else if(1===this.batchThreshold)this.list.push.apply(this.list,t),n=this.call(e,this.list),this.list.splice(0);else{if(!(this.batchThreshold>1))throw new Error(`### App Runtime ### push() 不支持的batchThreshold值：${this.batchThreshold}`);for(this.list.push.apply(this.list,t);this.list.length>=this.batchThreshold;){const t=this.list.splice(0,this.batchThreshold);n=this.call(e,t)}}return this._boolDefineNextTick&&this._defineNextTick(e),n}over(e,t){return this.list.length&&(this.call(e,this.list),this.list.splice(0)),this.call(e,t)}_defineNextTick(e){this._nextTick||(this._nextTick=Promise.resolve().then(()=>{this.list.length&&console.warn(`### App Runtime ### _defineNextTick(${e}) 应该由框架保证及时发送`),this._nextTick=null}))}}const qt=[{newN:"t",oldN:"type",newV:["d","a","t","u","p","pe"],oldV:["descendant","attribute","tag","universal","pseudo","pseudo-element"]},{newN:"n",oldN:"name"},{newN:"i",oldN:"ignoreCase"},{newN:"a",oldN:"action"},{newN:"v",oldN:"value"}];var Vt={registerComponents:function(e){"string"==typeof e&&(e=JSON.parse(e)),Array.isArray(e)||(e=[e]),e.forEach(e=>{if(!e)return;e.name||(e.name=e.type,delete e.type),e.methods=e.methods||[],global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Runtime ### 注册组件---- ",JSON.stringify(e));let t=me[e.name];t?t.methods=Array.from(new Set(t.methods.concat(e.methods))):(t=me[e.name]=JSON.parse(JSON.stringify(e))).def={}})},getComponentDefaultOptions:be,bindComponentMethods:function(e){const t=be(e.tagName.toLowerCase());if(t&&t.methods){const n=t.methods.filter(e=>"animate"!==e);return n.forEach(function(n){e[n]||(e[n]=function(...o){const r=re(e._docId);r?(r.invokeComponentMethod(t.name,e.ref,n,o),global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 调用组件的方法：${t.name}.${n}()`,JSON.stringify(o))):console.warn(`### App Runtime ### 调用组件的方法无效：${t.name}.${n}(), 组件已销毁`)})}),n}return[]},registerStyleObject:function(e,t,n,o,r){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 基于节点(${r&&r.ref})注册样式节点(${o})`),n&&(function(e){for(const t in e){const n=e[t];if(n&&n._meta&&n._meta.ruleDef){const e=n._meta.ruleDef;for(let t=0,n=e.length;t<n;t++){const n=e[t];for(let e=0,t=qt.length;e<t;e++){const t=qt[e];n.hasOwnProperty(t.newN)&&(n[t.oldN]=n[t.newN],delete n[t.newN],t.newV&&t.newV.indexOf(n[t.oldN])>-1&&(n[t.oldN]=t.oldV[t.newV.indexOf(n[t.oldN])]))}}}}}(n),function(e,t,n,o){const r=t.id;e._styleSheetHash[r]=t,n?e._styleSheetHash[0].push(r):o._styleSheetId=r}(e,xt(t,n),o,r))},createEvent:vt,createFigment:function(e){const t=new dt;return t._ownerDocument=e,t},updatePageTitleBar:function(e,t){const n=re(e._docId);n&&n.updatePageTitleBar(t)},exitFullscreen:function(e){const t=re(e._docId);t&&t.exitFullscreen()},setElementProp:function(e,t,n,o){if(!e._ownerDocument||"ref"===t)return;if(e[t]===n&&!1!==o)return;const r=e[t];e[t]=n,global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 元素的内部属性(${t})更新(${r}=>${n})`);const s=re(e._docId);s&&s.setProp(e.ref,t,n)},setElementAttr:st,setElementStyle:function(e,t,n,o){e._ownerDocument&&(ye(e)[t]===n&&!1!==o||(ye(e)[t]=n,at(e,o,"style",null,[t,n])))},setElementStyles:lt,getElementMatchedCssRuleList:function(e,t){const n=ct(e,t),o=JSON.parse(JSON.stringify(n));for(let t=0,n=o.length;t<n;t++){const n=o[t];n.editable=!0,n.style=fe(n._styleFullList,n.style),delete n._styleFullList;const r=pe(e._docId,n._sheetId);n.styleSheetName=r?r.name:""}return o},setElementMatchedCssRule:function(e,t,n){const o={},r=[];for(let e=0,t=n.length;e<t;e++){const t=n[e];r.push({name:t.name,value:t.value,disabled:t.disabled}),t.disabled||(o[t.name]=t.value)}const s=ct(e,t)[0];if(s){if(s.type===Me.INLINE)s._styleFullList=r,lt(e,o);else{const t=oe(e._docId);s._styleFullList=r,s.style=o;const n=function(e){return Object.keys(e._hitNodeMap)}(s);for(let e=0,o=n.length;e<o;e++){const o=le(t,n[e]),r=qe(s,o).match;global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 更新CSS规则(${s.name})的样式，元素(${o.ref})的匹配结果：${r}`),r&&(o._finalStyleCache=null,it(o))}}global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 更新样式:元素(${e.ref})的匹配样式：${t}:${JSON.stringify(o)}`)}else global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 更新样式:元素(${e.ref})无匹配样式：${t}`)},resetNodeChildren:function(e){for(let t=0,n=e.layoutChildren.length;t<n;t++){const n=e.layoutChildren[t];n._tmpRenderIndexInParent=Le(n,e)}e.childNodes.length=0,e.layoutChildren.length=0},restoreNodeChildren:function(e,t){if(!t.parentNode||t.parentNode!==e)return;e.childNodes.push(t),e.layoutChildren.push(t);const n=Se(e,!0);if(Ae(t)){const o=re(e._docId),r=ke(t),s=r!==t._tmpRenderIndexInParent;if(t._tmpRenderIndexInParent=null,o&&s)return o.moveNode(t,n,r)}},fireTargetEventListener:Re,clearTargetEventListener:function(e,t,n){n instanceof Object||(n={capture:!!n});const o=n.capture?K.CAPTURING_PHASE:K.BUBBLING_PHASE;e._eventTargetListeners[t]&&delete e._eventTargetListeners[t][o]},getDocumentNodeByRef:le,isNodeInDocument:function(e){return!(!e||!e._docId)},recreateDocument:function(e){const t=e.body;t?e.listener.createBody(t):console.error("### App Runtime ### Document没有body节点, 无法重建")},destroyTagNode:function(e){switch(e.nodeType){case Q.DOCUMENT:!function(e){var t;global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Runtime ### 销毁文档"),delete e._nodeMap,delete e.listener,delete e._styleSheetHash,e.documentElement&&Pe(e.documentElement),delete e.documentElement,delete e.body,delete e.childNodes,delete e.layoutChildren,Ie(e),t=e._docId,ne[t]=null}(e);break;case Q.ELEMENT:Pe(e);break;default:Ie(e)}},getNodeAsJSON:we,getNodeDepth:function(e){return e._depth}};const Yt=function(e,t,...n){return global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Bridge ### sendActions() 发送消息：${e},${t.length},${JSON.stringify(t)}`),t=JSON.stringify(t,function(e,t){return t&&t.constructor===RegExp?{type:E(t),source:t.source,flags:t.flags}:t}),global.callNative(e,t,...n)},Kt=function(e){const t=new Ut(Yt),n=new Gt(e,t);return new Et(e,n)};var Xt={init:function(){Object.freeze(K),Object.freeze(K.prototype),Object.freeze(rt),Object.freeze(rt.prototype),Object.freeze(Et),Object.freeze(Et.prototype),Object.freeze(ut),Object.freeze(ut.prototype),Object.freeze(dt),Object.freeze(dt.prototype),Object.freeze(pt),Object.freeze(pt.prototype),Object.freeze(ft),Object.freeze(ft.prototype),Object.freeze(te),Object.freeze(te.prototype),Object.freeze(ot),Object.freeze(ot.prototype),Object.freeze(Fe),Object.freeze(Fe.prototype),Object.freeze(ht),Object.freeze(ht.prototype),Vt.createDocument=Kt},Node:te,Event:K,TouchEvent:X,helper:Vt,exposure:{registerComponents:Vt.registerComponents}};const Zt={initApp:"quickapp.app.initApp",initPage:"quickapp.page.initPage",destroyPage:"quickapp.page.destroyPage",fireEvent:"quickapp.page.fireEvent",onShow:"quickapp.page.onShow",onHide:"quickapp.page.onHide",onBackPress:"quickapp.page.onBackPress",onMenuPress:"quickapp.page.onMenuPress",onOrientationChange:"quickapp.page.onOrientationChange",callbackDone:"quickapp.page.callbackDone"};class Qt{constructor(e,t){if(t instanceof Qt)return t;this.timestamp=Date.now(),this.detail=t,this.type=e;let n=!1;this.stop=function(){n=!0},this.hasStopped=function(){return n}}}const en=["onCreate","onInit","onReady","onShow","onHide","onDestroy","onBackPress","onMenuPress","onUpdateData","onOrientationChange"];Qt.reserveEvents=en,Qt.isReservedEvent=function(e){return en.indexOf(e)>=0};const tn=750,nn=320;const on={};Object.setPrototypeOf(on,new class{constructor(){this.eventMap={}}subscribe(e,t,n){if(n&&n.once){const n=o=>{t(o),this.remove(e,n)};return this.subscribe(e,n)}if(this.eventMap[e]=this.eventMap[e]||[],"function"==typeof t){const n=this.eventMap[e];-1===n.indexOf(t)&&n.push(t)}}publish(e,t,n){let o=null;const r=this.eventMap[e]||[];for(let e=0,n=r.length;e<n;e++)o=r[e](t,o);return o}remove(e,t){if(!this.eventMap[e])return;const n=this.eventMap[e],o=n.indexOf(t);o>-1&&n.splice(o,1)}});let rn=null;class sn extends W{constructor(e,t){super(...arguments),this._isApp=!0,this.options=t||{},this.name="",this.entry="",this.customComponentMap={},this.designWidth=tn,this._def=null,this._data={},this._events={},this._status=null,this._shareDocStyle=!1}$clear(){this.options={},this.name="",this.customComponentMap={},this.designWidth=tn,this._def=null,this._data={},this._events={},this.destroy()}get $data(){return T(this._data)||(this._data={}),this._data}set $data(e){const t="function"==typeof e?e():e;t?(this._data=this._data||{},Object.keys(t).forEach(e=>{!function(e){const t=(e+"").charCodeAt(0);return 36===t||95===t}(e)?(e in this._data&&console.warn(`### App Framework ### App 全局数据 (${e}) 被覆盖`),this._data[e]=t[e]):console.error(`### App Framework ### 页面数据属性名 '${e}' 非法, 属性名不能以$或_开头`)})):(this._data={},console.warn("### App Framework ### App 全局数据被清空"))}get $def(){return this._def}set $def(e){global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### App 元数据初始化----"),this._def=e;const t=e.manifest;if(global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### App 元数据manifest----",JSON.stringify(t)),t){this.name=t.name;const e=t.config;global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### App 元数据config----",JSON.stringify(e)),e&&(this.$data=e.data,this.designWidth=e.designWidth||tn,this.designWidth<nn&&(this.designWidth=nn),this._shareDocStyle=!!e.shareDocStyle);const n=t.router;global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### App 元数据router----",JSON.stringify(n)),n&&(this.entry=n.entry||"")}for(const t in e){"function"!=typeof e[t]||Qt.isReservedEvent(t)||(this[t]=e[t])}this.$on("applc:onCreate",function(e){this._status=e.type.toLowerCase().replace(/.*:on/,"")}),this.$on("applc:onDestroy",function(e){this._status=e.type.toLowerCase().replace(/.*:on/,"")}),Qt.reserveEvents.forEach(t=>{this.$on(`applc:${t}`,e[t])}),this._defined=!0}get $status(){return this._status}get $valid(){return"create"===this._status}$emit(e,t){const n=this._events[e];if(n)for(let o=0;o<n.length;o++){const r=new Qt(e,t);n[o].call(this,r)}}$on(e,t){if(!e||"function"!=typeof t)return;const n=this._events;n[e]=n[e]||[],n[e].push(t)}$off(e){if(!e)return;delete this._events[e]}exit(){null===rn&&(rn=on.platform.requireModule(this,"system.app")),rn.exit(this.id)}}Object.freeze(sn),Object.freeze(sn.prototype);class ln extends W{constructor(e,t,n,o,r){super(...arguments),this._isPage=!0,this.app=t,this.name=null,this.vm=null,this.intent=n,this.doc=on.runtime.helper.createDocument(e),this.doc.designWidth=this.app.designWidth,this._valid=!0,this._visible=!1,this._meta=Object.assign({},n,o),this._orientation=n.orientation,r&&this._registerCss(r)}_registerCss(e){const t=e&&e.list||[];for(let e=0,n=t.length;e<n;e++)on.runtime.helper.registerStyleObject(this.doc,"index",t[e],!0)}get $valid(){return this._valid}get $visible(){return this._valid&&this._visible}get orientation(){return this._orientation}get pageName(){return this._meta.name}get pageComponent(){return this._meta.component}invoke(...e){super.invoke(...e),this.$valid&&on.publish(Zt.callbackDone,[this])}}function an(e,t,n=[],o){if(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 调用页面(${e.id})的回调(${t}) 参数：`,JSON.stringify(n)),!e._callbacks)return new Error(`invoke: 回调函数 "${t}" 没有注册`);if(!e.$valid)return void console.error(`invoke: 回调函数所属对象(${e.id})已经无效, 终止回调执行`);const r=e._callbacks[t];if("function"==typeof r){const s=r(...n);return void 0!==o&&!1!==o||(e._callbacks[t]=void 0),e.doc&&on.publish(Zt.callbackDone,[e]),s}return new Error(`callback: 无效回调函数Id "${t}"`)}function cn(e,t){switch(E(e)){case"undefined":case"null":return"";case"regexp":return e.toString();case"date":return e.toISOString();case"number":case"string":case"boolean":case"array":return e;case"object":if(e.nodeType)return e.ref;const n={};for(const o in e)n[o]=cn(e[o],t);return n;case"function":const o=k();return t._callbacks?t._callbacks[o]=e:global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### normalize() 页面已经销毁，不再注册回调"),o.toString();default:return JSON.stringify(e)}}let un={};const pn={},dn={},hn={};function fn(e){hn[e]=function(...t){for(const n in un){const o=un[n];o&&o[e]&&o[e](...t)}}}function gn(e){hn[e]="createApplication"===e?function(t,n){let o=pn[t];return o?new Error(`Runtime ${e}:无效应用id "${t}"`):(o={framework:"xFramework",created:Date.now()},pn[t]=o,console.log(`### App Framework ### 创建应用 ${t}---- 框架: ${o.framework} 版本: ${global.frameworkVersion}`),un[o.framework].createApplication(t,n))}:"destroyApplication"===e?function(t){const n=pn[t];if(n&&un[n.framework]){const e=un[n.framework].destroyApplication(t);return pn[t]=null,e}return new Error(`Runtime ${e}:无效应用Id:  "${t}"`)}:function(...t){const n=t[0],o=pn[n];return o&&un[o.framework]?un[o.framework][e](...t):new Error(`Runtime ${e}:无效应用Id:  "${n}"`)}}function mn(e){let t,n;"string"==typeof e?t=e:e.length&&e.length>1&&(t=e[0],n=e[1]),"createPage"===t?hn[t]=function(e,n,o,r,s,l,a){const i=pn[n];if(!i)return new Error(`Runtime ${t}:无效应用id "${n}"`);let c=dn[e];return c?new Error(`Runtime ${t}:无效页面id "${e}"`):(c={appId:n,created:Date.now()},dn[e]=c,console.log(`### App Framework ### 创建页面 ${e}----应用Id: ${n}`),un[i.framework].createPage(e,n,o,r,s,l,a))}:(hn[t]=function(...n){const o=n[0],r=dn[o];if(r){const s=pn[r.appId];if(s&&un[s.framework]){const r=un[s.framework][t](...n);return"destroyPage"===e&&(dn[o]=null),r}return new Error(`Runtime ${t}:无效应用Id:  "${r.appId}"`)}return"backPressPage"===e?(console.error(`### App Framework ### backPressPage 无效页面Id:  "${o}"`),!1):new Error(`Runtime ${t}:无效页面Id:  "${o}"`)},n&&(hn[n]=function(...e){const n=e[0],o=dn[n];if(o){const r=pn[o.appId];return r&&un[r.framework]?un[r.framework][t](...e):new Error(`Runtime ${t}:无效页面Id: "${n}"`)}}))}const bn=["registerDsl","locateDsl"],vn=["createApplication","getAppConfig","notifyAppError","destroyApplication"],yn=["createPage","destroyPage","recreatePage","changeVisiblePage","backPressPage","menuPressPage","orientationChangePage",["processCallbacks","execJSBatch"],"getPage","getPageRoot","getPageElementStyles","setPageElementStyles","setPageElementAttrs","replacePageElementWithHtml"];const En={},_n={};function Nn(e){let t=e;"string"==typeof e&&(t=y({},`${e}; return dsl;`)),function(e){e.init(on)}(t)}const wn={1:(e,...t)=>(function e(t,n,o,r,s){if(!t.$valid)return new Error("fireEvent: 只有Page才能发送Dom事件");if(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 向页面(${t.id}) 的节点(${n})发送事件 "${o}"---- ${JSON.stringify(s)}`),Array.isArray(n))return void n.some(n=>!1!==e(t,n,o,r));return on.publish(Zt.fireEvent,[t,n,o,r,s])})(e,...t),2:(e,...t)=>an(e,...t)};const An={config:on,init:function(e){on.platform=e.platform,on.runtime=e.runtime,on.dock=e.dock,function(e){un={xFramework:e.dock},bn.forEach(fn),vn.forEach(gn),yn.forEach(mn)}(e)},locateDsl:function(){let e=global.getManifestField("config.dsl.name");e||(global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### 无法从manifest找到对应的dsl名称"),e="xvm");let t=on.platform.loadResource("dsl.js");t?global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### 从安装包中获取dsl"):(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 从平台中获取dsl-${e}`),t=on.platform.loadResource(`assets:///js/dsls/dsl-${e}.js`)),Nn(t)},registerDsl:Nn,createApplication:function(e,t){let n,o=En[e];return o?n=new Error(`createApplication: 无效应用Id "${e}"`):(global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### 平台配置信息：",JSON.stringify(global.Env)),o=new sn(e),En[e]=o,n=on.publish(Zt.initApp,[o,t])),n},notifyAppError:function(e,t){const n=En[e];if(n){if(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### notifyAppError 应用(${e})响应`),n.$def&&"function"==typeof n.$def.onError)try{n.$def.onError.call(n,t)}catch(e){throw e.message=`$INTERRUPTION$:${e.message}`,e}}else console.error(`### App Framework ### notifyAppError 应用(${e})无效`)},destroyApplication:function(e){const t=En[e];return t?(function(e){e.$emit("applc:onDestroy"),e.$clear(),global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 成功销毁应用(${e.id})----`)}(t),En):new Error(`destroyApplication: 无效应用Id "${e}"`)},createPage:function(e,t,n,o,r,s,l){const a=En[t];if(!a)return new Error(`createPage: 无效应用Id "${t}"`);l=JSON.parse(l||null);let i,c=_n[e];if(c)i=new Error(`createPage: 无效页面Id "${e}"`);else{global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 创建页面(${e})---- `,JSON.stringify(r)),c=new ln(e,a,r,s,l),_n[e]=c;const t=function(e,t,n){const o=e,r={};return{setTimeout:function(e,s){const l=n(e,o),a=global.setTimeoutWrap(o.id,function(){t(o,l)},s||0);return r[a.toString()]=l,a.toString()},setInterval:function(e,s){const l=n(e,o),a=global.setIntervalWrap(o.id,function(){t(o,l,[],!0)},s||0);return r[a.toString()]=l,a.toString()},clearTimeout:function(e){global.clearTimeoutWrap(e),r[e]=void 0},clearInterval:function(e){global.clearIntervalWrap(e),r[e]=void 0},requestAnimationFrame:function(e){const s=n(e,o),l=global.requestAnimationFrameWrap(o.id,function(){t(o,s)});return r[l.toString()]=s,l.toString()},cancelAnimationFrame:function(e){global.cancelAnimationFrameWrap(e),r[e]=void 0}}}(c,an,cn);i=on.publish(Zt.initPage,[c,n,o,t])}return i},recreatePage:function(e){const t=_n[e];let n;return n=t?function(e){if(console.log(`### App Framework ### 重建页面(${e.id})----`),!e.$valid)return console.error(`### App Framework ### 页面(${e.id})缺少dom数据`),new Error("recreatePage: 无效数据");on.runtime.helper.recreateDocument(e.doc),e.doc.listener.createFinish()}(t):new Error(`recreatePage: 无效页面Id "${e}"`)},destroyPage:function(e){const t=_n[e];return t?(on.publish(Zt.destroyPage,[t]),function(e){console.log(`### App Framework ### 销毁页面(${e.id})----`),e.intent=null,e.name=null,on.runtime.helper.destroyTagNode(e.doc),e.doc=null,e._valid=!1,e._visible=!1,e.destroy(),global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### 成功销毁页面(${e.id})----`)}(t),delete _n[e],_n):new Error(`destroyPage: 无效页面Id "${e}"`)},changeVisiblePage:function(e,t){const n=_n[e];if(n){global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### changeVisiblePage 页面(${e})响应：${t}`),n._visible=t;const o=t?Zt.onShow:Zt.onHide;on.publish(o,[n])}else console.error(`### App Framework ### changeVisiblePage 页面(${e})无效`)},backPressPage:function(e){const t=_n[e];let n=!1;return t?(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### backPressOnPage 页面(${e})响应`),n=on.publish(Zt.onBackPress,[t])):console.error(`### App Framework ### backPressOnPage 页面(${e})无效`),!0!==n&&(n=!1),n},menuPressPage:function(e){const t=_n[e];let n=!1;return t?(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### menuPressOnPage 页面(${e})响应`),n=on.publish(Zt.onMenuPress,[t])):console.error(`### App Framework ### menuPressOnPage 页面(${e})无效`),n},orientationChangePage:function(e,t){const n=_n[e];n?(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Framework ### orientationChangePage 页面(${e})响应：${JSON.stringify(t)}`),on.publish(Zt.onOrientationChange,[n,t])):console.error(`### App Framework ### orientationChangePage 页面(${e})无效`)},processCallbacks:function(e,t){if(!Array.isArray(t))return new Error(`processCallbacks: 无效任务回调数据 "${e}"`);let n=_n[e];if(n||(n=En[e]),n){const e=[];return t.forEach(t=>{const o=wn[t.action],r=[...t.args];"function"==typeof o?(r.unshift(n),e.push(o(...r))):(console.error(`### App Framework ### 无法识别的回调函数类型 (${t.action})`),e.push("invalid"))}),e}return new Error(`processCallbacks: 无效回调来源Id "${e}"`)},getAppConfig:function(e){const t=En[e];let n;return n=t?t.$def:new Error(`getAppConfig: 无效应用Id "${e}"`)},getPageRoot:function(e){const t=_n[e];let n;return n=t?function(e){const t=(e.doc||{}).body||{};return on.runtime.helper.getNodeAsJSON(t)}(t):new Error(`getPageRoot: 无效页面Id "${e}"`)},getPage:function(e){return _n[e]},getPageElementStyles:function(e,t){const n=_n[e];let o;return o=n&&n.doc?function(e,t){let n;const o=on.runtime.helper.getDocumentNodeByRef(e.doc,t);if(o){const e=on.runtime.helper.getElementMatchedCssRuleList(o);return n={inlineStyle:e.shift(),matchedCSSRules:e}}return n=new Error(`getElementStyles: 无效节点ref "${t}"`)}(n,t):new Error(`getPageElementStyles: 无效页面Id "${e}"`)},setPageElementStyles:function(e,t,n,o){const r=_n[e];let s;return r&&r.doc?(global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### 更新页面元素样式: ",JSON.stringify(arguments)),s=function(e,t,n,o){let r;const s=on.runtime.helper.getDocumentNodeByRef(e.doc,t);if(s){for(let e=0,t=o.length;e<t;e++){const t=o[e];t.name=w(t.name)}r=on.runtime.helper.setElementMatchedCssRule(s,n,o),e.doc.listener.updateFinish()}else r=new Error(`setPageElementStyles: 无效节点ref "${t}"`);return r}(r,t,n,o)):s=new Error(`setPageElementStyles: 无效页面Id "${e}"`),s},setPageElementAttrs:function(e,t,n){const o=_n[e];let r;return o&&o.doc?(global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### 更新页面元素的属性: ",JSON.stringify(arguments)),r=function(e,t,n){let o;const r=on.runtime.helper.getDocumentNodeByRef(e.doc,t);if(r){for(let e=0,t=n.length;e<t;e++){const t=n[e];if(t.name=w(t.name.trim()),""===t.name);else if("style"===t.name){const e=t.value.split(";").map(e=>{const t=e.split(":");return{name:w(t[0].trim()),value:t[1]}}).filter(e=>""!==e.name);on.runtime.helper.setElementMatchedCssRule(r,"INLINE",e)}else on.runtime.helper.setElementAttr(r,t.name,t.value)}e.doc.listener.updateFinish()}else o=new Error(`setElementAttrs: 无效节点ref "${t}"`);return o}(o,t,n)):r=new Error(`setPageElementAttrs: 无效页面Id "${e}"`),r},replacePageElementWithHtml:function(e,t,n){const o=_n[e];let r;if(o&&o.doc){const e=on.runtime.helper.getDocumentNodeByRef(o.doc,t),s=e.parentNode,l=s.layoutChildren.indexOf(e);try{const t=on.platform.requireBundle("parser.js").parseHTML(n),a=function e(t,n){if(global.Env&&"trace"===global.Env.logLevel&&console.trace(`### App Runtime ### 编译节点：${JSON.stringify(t)}`),t.hasOwnProperty("length")){const o=[];for(let r=0,s=t.length;r<s;r++){const s=e(t[r],n);s&&o.push(s)}return o}if(!t.nodeType||t.nodeType===n.NodeType.ELEMENT){const o=n.createElement(t.type);for(const e in t.attr)on.runtime.helper.setElementAttr(o,e,t.attr[e]);t.classList&&t.classList.length&&on.runtime.helper.setElementAttr(o,"class",t.classList.join(" "));for(const e in t.style)on.runtime.helper.setElementStyle(o,e,t.style[e]);if(t.children)for(let r=0,s=t.children.length;r<s;r++){const s=e(t.children[r],n);s&&o.appendChild(s)}return o}console.warn(`### App Runtime ### 不支持插入的节点类型：${t.nodeType}`)}(t,o.doc);if(a){s.removeChild(e);const t=a.hasOwnProperty("length")?a:[a];for(let e=0,n=t.length;e<n;e++){const n=t[e];s.insertBefore(n,s.layoutChildren[l+e])}o.doc.listener.updateFinish(),global.Env&&"trace"===global.Env.logLevel&&console.trace("### App Framework ### 使用HTML替换元素:",JSON.stringify(arguments),JSON.stringify(t))}else r=new Error(`replacePageElementWithHtml: 使用HTML替换元素，编译出错：${JSON.stringify(t)}`)}catch(e){r=new Error(`replacePageElementWithHtml: 使用HTML替换元素：${e}`)}}else r=new Error(`replacePageElementWithHtml: 无效页面Id "${e}"`);return r},bindComponentMethods:function(e,t){t&&!t._hasBind&&("canvas"===t.tagName.toLowerCase()?function(e,t){const n=on.platform.requireBundle("canvas.js"),o=on.platform.requireModule(t.app,"system.canvas");e=n.enable(e,t.app,{module:o})}(t,e):(t.animate=function(e,t){return(n,o)=>{const r={keyframes:n,options:o},s=on.platform.requireBundle("animation.js"),l=on.platform.requireModule(t.app,"system.animation"),a=new s(t,e,r,l);return Object.freeze(a)}}(t,e),on.runtime.helper.bindComponentMethods(t).forEach(function(n){const o=t[n];t[n]=function(...r){if(e&&e.doc&&e.$valid){on.publish(Zt.callbackDone,[e]);const s=r.map(t=>cn(t,e));o.apply(t[n],s)}}})),t._hasBind=!0);return t},exposure:hn};global.initInfras=function(){global.frameworkVersion=e;const t={};t.platform=Y,Y.init(),t.platform.exposeToNative(Y.exposure),global.BroadcastChannel=Y.BroadcastChannel,global.ENGINE_TYPE=Y.ENGINE_TYPE,t.runtime=Xt,Xt.init(),t.platform.exposeToNative(Xt.exposure),t.dock=An,An.init(t),t.platform.exposeToNative(An.exposure),t.platform.defineBundle("parser"),t.platform.defineBundle("canvas"),t.platform.defineBundle("animation")}});
//# sourceMappingURL=infras.js.map
